<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.113" />
    <link rel="alternate" title="Perl Advent Calendar 2017 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2017.css" type="text/css" />
    <title>
Perl Advent Calendar 2017 - 
Maybe not

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2017</a></h1>
        </div>

        <p id="tagline">2017 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Maybe not</h1>
<div class='subtitle'>MooseX::LazyRequire, MooseX::UndefTolerant::Attribute - 2017-12-19</div>

<div class='pod'><p>&quot;What&#39;s this <code>Maybe</code> here for?&quot; asked the Wise Old Elf. He was looking at the new Moose code that Syllabub Fizzyboughs had written for the new and improved Sleigh operating system.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="word">has</span> <span class="word">gps_unit</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span>  <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">isa</span> <span class="operator">=&gt;</span> <span class="word">Maybe</span><span class="structure">[</span><span class="word">class_type</span><span class="structure">(</span><span class="single">'GPSUnit'</span><span class="structure">)]</span><span class="operator">,</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>&quot;You see, Wise Old Elf, the <code>Maybe</code> says that the value can either be whatever is in the brackets or can be <code>undef</code>. So this means the value has to be something that&#39;s a GPS unit or undef - in case there&#39;s no GPS unit attached, you see.&quot;, Syllabub explained.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$basic_sleigh</span> <span class="operator">=&gt;</span> <span class="word">Sleigh</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Mk I'</span><br /><span class="structure">);</span><br /><br /><span class="comment"># prints nothing!<br /></span><span class="word">say</span> <span class="symbol">$basic_sleigh</span><span class="operator">-&gt;</span><span class="word">gps_unit</span><span class="operator">-&gt;</span><span class="word">name</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">if</span> <span class="core">defined</span> <span class="symbol">$basic_sleigh</span><span class="operator">-&gt;</span><span class="word">gps_unit</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$fancy_sleigh</span> <span class="operator">=&gt;</span> <span class="word">Sleigh</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Mk II'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">gps_unit</span> <span class="operator">=&gt;</span> <span class="word">GPSUnit</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Super GPS 2001'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span><span class="operator">,</span><br /><span class="structure">);</span><br /><br /><span class="comment"># prints 'Super GPS 2001'<br /></span><span class="word">say</span> <span class="symbol">$fancy_sleigh</span><span class="operator">-&gt;</span><span class="word">gps_unit</span><span class="operator">-&gt;</span><span class="word">name</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">if</span> <span class="core">defined</span> <span class="symbol">$fancy_sleigh</span><span class="operator">-&gt;</span><span class="word">gps_unit</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>&quot;Yes, yes. I know what <code>Maybe</code> <b>does</b>. But I asked <b>what</b> it&#39;s there for. Haven&#39;t you heard the expression &#39;Maybe is a code smell?&#39;&quot;</p>

<p>&quot;No Wise Old Elf, can&#39;t say that I have. To be honest, I&#39;m not sure what you mean by code smell. My keyboard smells of freshly baked cookies like any other workstation at the North Pole.&quot;</p>

<p>&quot;A code smell, by young elf, is a pattern that indicates that probably there&#39;s something wrong with your code. Other people call them &#39;Red Flags&#39;. In this case it&#39;s because nine times out of ten, if you&#39;re using a <code>Maybe</code> you&#39;re better off using a predicate&quot;</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="word">has</span> <span class="word">gps_unit</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span>        <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">isa</span>       <span class="operator">=&gt;</span> <span class="word">class_type</span><span class="structure">(</span><span class="single">'GPSUnit'</span><span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">predicate</span> <span class="operator">=&gt;</span> <span class="single">'has_gps_unit'</span><span class="operator">,</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>&quot;Or, if you&#39;re using <a href="https://metacpan.org/module/MooseX::AttributeShortcuts">MooseX::AttributeShortcuts</a>&quot;</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="word">has</span> <span class="word">gps_unit</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span>        <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">isa</span>       <span class="operator">=&gt;</span> <span class="word">class_type</span><span class="structure">(</span><span class="single">'GPSUnit'</span><span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">predicate</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>&quot;So now you can use the <code>has_gps_unit</code> method&quot;</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># prints 'Super GPS 2001'<br /></span><span class="word">say</span> <span class="symbol">$fancy_sleigh</span><span class="operator">-&gt;</span><span class="word">gps_unit</span><span class="operator">-&gt;</span><span class="word">name</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">if</span> <span class="core">defined</span> <span class="symbol">$fancy_sleigh</span><span class="operator">-&gt;</span><span class="word">has_gps_unit</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<h3 id="MooseX::LazyRequire">MooseX::LazyRequire</h3>

<p>&quot;Okay&quot;, Syllabub asked, &quot;why would I want to do that?&quot;</p>

<p>The Wise Old Elf explained, for starters, it&#39;s a lot more readable with exactly what&#39;s going on when you use the <code>has_gps_unit</code> method. But what really blew Syllabub&#39;s mind was when the Wise Old Elf showed him <a href="https://metacpan.org/module/MooseX::LazyRequires">MooseX::LazyRequires</a>.</p>

<p>Even with a predicate you can still read from an attribute that hasn&#39;t been set in the constructor, and you&#39;ll get <code>undef</code> back. This can result in hard to debug problems, where the value is taken, passed somewhere else, then much later in your code when something tries to access it...</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># in Sleigh<br /></span><span class="keyword">sub</span> <span class="word">fly_to_destination</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$place</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$trip</span> <span class="operator">=</span> <span class="word">Trip</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">start</span> <span class="operator">=&gt;</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">current_location</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">end</span>   <span class="operator">=&gt;</span> <span class="symbol">$place</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">gps</span>   <span class="operator">=&gt;</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">gps_unit</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$trip</span><span class="operator">-&gt;</span><span class="word">route</span><span class="structure">(</span><span class="symbol">$self</span><span class="structure">);</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>This leads to the really unreadable error message from deep within the <code>Trip</code> class&#39;s <code>route</code> method if the <code>gps_unit</code> attribute isn&#39;t set and returns <code>undef</code> when <code>fly_to_destination</code> is called. What you really need to do is throw an exception as soon as you try reading from an accessor that isn&#39;t set. That&#39;s what MooseX::LazyRequires does for any attribute that has the <code>lazy_requires</code> parameter enabled:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">MooseX::LazyRequire</span><span class="structure">;</span><br /><br /><span class="word">has</span> <span class="word">gps_unit</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span>            <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">predicate</span>     <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">lazy_required</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>Which now, if you don&#39;t set the <code>gps_unit</code> prior to calling <code>fly_to_destination</code>, <b>immediately</b> generates a much more readable error message:</p>

<pre><code>    Attribute &#39;gps_unit&#39; must be provided before calling reader
        at /opt/perl/lib/site_perl/5.22.0/MooseX/LazyRequire/Meta/Attribute/Trait/LazyRequire.pm line 34.
        MooseX::LazyRequire::Meta::Attribute::Trait::LazyRequire::__ANON__(Sleigh=HASH(0x7fd3a1807908))
           called at reader Sleigh::gps_unit (defined at Sleigh.pm line 7) line 6
        Sleigh::gps_unit(Sleigh=HASH(0x7fd3a1807908))
           called at Sleigh.pm line 18
        Sleigh::fly_to_destination(Sleigh=HASH(0x7fd3a1807908))
           called at example.pl line 6</code></pre>

<p>Syllabub was convinced and made the changes to all of his code.</p>

<h3 id="MooseX::UndefTolerant::Attribute">MooseX::UndefTolerant::Attribute</h3>

<p>&quot;Wise Old Elf, I&#39;ve got a problem&quot;, Syllabub explained the next day, &quot;I changed all my code and now it&#39;s broken wherever I pass in <code>undef</code>&quot;</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$sleigh</span> <span class="operator">=&gt;</span> <span class="word">Sleigh</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Mk III'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">gps_unit</span> <span class="operator">=&gt;</span> <span class="symbol">$factory</span><span class="operator">-&gt;</span><span class="word">gps_unit</span><span class="operator">,</span> <span class="comment"># might return undef if there isn't one</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>&quot;We do this all over the place. Do I have to change all my code?&quot;. Syllabub showed the Wise Old Elf what he&#39;d been &quot;<i>forced</i>&quot; to write:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$gps</span> <span class="operator">=</span> <span class="symbol">$factory</span><span class="operator">-&gt;</span><span class="word">gps_unit</span><span class="structure">;</span><br /><span class="keyword">if</span> <span class="structure">(</span><span class="symbol">$gps</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$sleigh</span> <span class="operator">=</span> <span class="word">Sleigh</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Mk III'</span><span class="operator">,</span> <span class="word">gps_unit</span> <span class="operator">=&gt;</span> <span class="symbol">$gps</span> <span class="structure">);</span><br /><span class="structure">}</span> <span class="keyword">else</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$sleigh</span> <span class="operator">=</span> <span class="word">Sleigh</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Mk III'</span> <span class="structure">);</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>The Wise Old Elf explained that he could probably make his life a lot easier with the ternary operator:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$gps</span> <span class="operator">=</span> <span class="symbol">$factory</span><span class="operator">-&gt;</span><span class="word">gps_unit</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$sleigh</span> <span class="operator">=</span> <span class="word">Sleigh</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Mk III'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">(</span><span class="symbol">$gps</span> <span class="operator">?</span> <span class="structure">(</span> <span class="word">gps_unit</span> <span class="operator">=&gt;</span> <span class="symbol">$gps</span> <span class="structure">)</span> <span class="operator">:</span> <span class="structure">())</span><span class="operator">,</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>But there was another simpler strategy: Use <a href="https://metacpan.org/module/MooseX::UndefTolerant::Attribute">MooseX::UndefTolerant::Attribute</a> to allow <code>undef</code> to mean the same thing as <i>we didn&#39;t pass a value</i>.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">MooseX::UndefTolerant::Attribute</span><span class="structure">;</span><br /><br /><span class="word">has</span> <span class="word">gps_unit</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">traits</span>        <span class="operator">=&gt;</span> <span class="structure">[</span> <span class="word">UndefTolerant</span> <span class="structure">]</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">is</span>            <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">predicate</span>     <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">lazy_required</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span><br /><span class="structure">);</span><br /><br /><span class="operator">...</span><br /><br /><span class="comment"># this now works fine, as if gps_unit hadn't been passed<br /></span><span class="word">my</span> <span class="symbol">$sleigh</span> <span class="operator">=&gt;</span> <span class="word">Sleigh</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">name</span> <span class="operator">=&gt;</span> <span class="single">'Mk IV'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">gps_unit</span> <span class="operator">=&gt;</span> <span class="core">undef</span><span class="operator">,</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<h3 id="Cleaner-Code-All-Round">Cleaner Code All Round</h3>

<p>Syllabub was happy. His code was a lot easier to debug, and he&#39;d learned something from the Wise Old Elf. Code review might be painful, but everything was a lot better afterward.</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/5d71b5f0c61e97cd452d625cc24a4c82?r=g&s=80&d=retro />
This article contributed by: Mark Fowler &lt;mark@twoshortplanks.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Project Multipli-sleigh-ion" href="2017-12-18.html">Previous</a></li>

    <li class="next"><a title="Reindeer" href="2017-12-20.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-27056407-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>





